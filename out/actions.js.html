<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: actions.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: actions.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Functions used for live updating
/**
 * Update view based on actions performed
 * @param config
 * @param isRobot
 * @returns {*}
 */
const configureHtml = (config, isRobot) => {
    // Update cell colour once it has been hit
    // Add any other style changes to the cell
    if (isRobot) {
        attackFleet.isLocked = true
        queueTimeout(() => {
            if (config.isHit) {
                config.attributes.styles.backgroundColor = config.hasShip ? 'red' : 'white'
            }
            config = updateElement(config)
            attackFleet.isLocked = false
            return config
        }, 0)
    } else {
        if (config.isHit) {
            config.attributes.styles.backgroundColor = config.hasShip ? 'red' : 'white'
        }
        config = updateElement(config)
    }
    return config
}

/**
 * Given a cell and new config data, update the data of the cell
 * @param config
 * @param matrix
 * @param x
 * @param y
 * @param z
 * @param isRobot
 */
const update3dCell = (config, matrix, x, y, z, isRobot = false) => configureHtml(mergeObjectsMutable(matrix.children[z].children[y].children[x], config), isRobot)

/**
 *
 */
const setViewShip = curry(update3dCell)(mergeObjects(shipTile(), {attributes: {styles: {backgroundColor: '#777',},},}))

/**
 *
 */
const setHiddenShip = curry(update3dCell)(shipTile())

/**
 *
 */
const setHit = curry(update3dCell)(hitTile())

/**
 * Set a specified point to be part of a ship
 * @param matrix
 * @param point
 * @param view
 */
const setShip = (matrix, point, view) => view ? setViewShip(matrix, point.x, point.y, point.z) : setHiddenShip(matrix, point.x, point.y, point.z)

/**
 *
 * @param player
 * @param status
 * @returns {*}
 */
const updatePlayerStats = (player, status = `${Math.round(player.status * 100) / 100}%`) => {
    player.playerStats = updateElements(mergeObjects(player.playerStats, playerStats(player, status)))
    return player
}

/**
 * Track player stats such as attacks and turns
 * @param player
 * @param playAgain
 * @param sunkShip
 */
const updatePlayer = (player, playAgain, sunkShip = 0) => {
    if (player.attacker) {
        if (playAgain) {
            ++player.attacks.hit
        } else {
            ++player.attacks.miss
        }
        if (sunkShip) {
            ++player.attacks.sunk
        }
    }
    let result = {}
    if (!playAgain) {
        player.attacker = !player.attacker
        attackFleet.isLocked = true
        if (player.attacker) {
            result = queueTimeout(() => {
                attackFleet.isLocked = false
                return player.board.children.map(l => l.children.map(r => r.children.map(c => updateElement(mergeObjects(c, {
                    attributes: {
                        styles: {
                            width: '17px',
                            height: '17px'
                        }
                    }
                })))))
            }, 400)
            ++player.turnCnt
        } else {
            result = queueTimeout(() => {
                attackFleet.isLocked = false
                return player.board.children.map(l => l.children.map(r => r.children.map(c => updateElement(mergeObjects(c, {
                    attributes: {
                        styles: {
                            width: '35px',
                            height: '35px'
                        }
                    }
                })))))
            }, 0)
        }
    }
    result = queueTimeout(() => updatePlayerStats(player, player.attacker ? 'ATTACKER' : `${Math.round(player.status * 100) / 100}%`), 0)
    return result.result || player
}

/**
 * Final state once a game is won (only one player remains)
 * @param winner
 * @returns {Array.&lt;*>}
 */
const endGame = (winner) => {
    let parent = getTopParentItem(winner)
    let players = winner.parentItem.children
    players.map(player => updatePlayerStats(player))
    winner = updatePlayerStats(winner, 'WINNER')
    renderHTML(finalScore(players), parent)
    return [winner]
}

/**
 *
 * @param attacker
 * @param players
 * @param attackerIndex
 * @returns {*}
 */
const findNextAttacker = (attacker, players, attackerIndex) => {
    let nextAttacker = (players.length > 1 &amp;&amp; attackerIndex >= players.length - 1) ? players[0] : players[++attackerIndex]
    return nextAttacker.status > 0 ? nextAttacker : findNextAttacker(attacker, players, attackerIndex) // Only use players with a positive status
}

/**
 * Based on the current attacker and list of players, return the next attacker.
 * @param attacker
 * @param players
 * @param playAgain
 * @returns {*}
 */
const getNextAttacker = (attacker, players, playAgain) => playAgain ? attacker : updatePlayer(findNextAttacker(attacker, players, players.indexOf(attacker)), playAgain)

/**
 * Update all game stats after each player round
 * @param player
 * @param hitShip
 * @param sunkShip
 * @param players
 * @param target
 * @returns {*}
 */
const updateScore = (player, hitShip, sunkShip, players, target) => {
    players = players.filter((p) => p.status > 0)
    let attacker = players.reduce((p1, p2) => p1.attacker ? p1 : p2)
    attacker = updatePlayer(attacker, hitShip, sunkShip)
    if (players.length &lt; 2) {
        return queueTimeout(() => endGame(players[0]), 200)
    }
    let nextAttacker = getNextAttacker(attacker, players, hitShip)
    if (nextAttacker.isRobot) {
        queueTimeout(computerAttack, 0, nextAttacker, players)
    }
    return players
}

/**
 * Perform attack on an enemy board / cell
 * @param target
 * @returns {*}
 */
const attackFleet = (target) => {
    attackFleet.isLocked = attackFleet.isLocked || false
    let player = getParentsByClass('player', target)[0]
    let players = getParentsByClass('boards', target)[0].children
    // Player cannot attack themselves (current attacker) or if they have bad status
    if (player.status &lt;= 0 || player.attacker || attackFleet.isLocked) {
        return players
    }
    // Update cell to hit
    let hitCell = setHit(player.board, target.point.x, target.point.y, target.point.z, players.reduce((p1, p2) => p1.attacker ? p1 : p2).isRobot)
    let hitShip = false
    let sunkShip = 0
    if (hitCell.hasShip) {
        let status = 0
        // Update all ship status and player status by checking all ships / parts
        player.shipFleet.map((ship) => {
            // Get all healthy ships
            let healthy = ship.parts.filter((part) => {
                if (checkEqualPoints(part.point, target.point)) {
                    hitShip = ship
                }
                return !part.isHit
            })
            // Create percentage health status
            ship.status = healthy.length / ship.parts.length * 100
            // Create sum of ship status
            status += ship.status
            return ship
        })
        // Divide sum of ship statuses by number of ships to get player status
        player.status = status / player.shipFleet.length
    }
    if (hitShip) {
        player = updatePlayerStats(player, `${Math.round(player.status * 100) / 100}%`)
        // Check if the hit ship was sunk
        sunkShip = hitShip.status &lt;= 0 ? hitShip.parts.length : 0
    }
    return updateScore(player, hitCell.hasShip, sunkShip, players, target.point)
}

const attackListener = (e, target, args = {}) => attackFleet(target)
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="global.html#DOMItem">DOMItem</a></li></ul><h3>Global</h3><ul><li><a href="global.html#adjacentEdgePoints">adjacentEdgePoints</a></li><li><a href="global.html#adjacentPoints">adjacentPoints</a></li><li><a href="global.html#appendAllHTML">appendAllHTML</a></li><li><a href="global.html#appendHTML">appendHTML</a></li><li><a href="global.html#appendListeners">appendListeners</a></li><li><a href="global.html#assignListener">assignListener</a></li><li><a href="global.html#attackFleet">attackFleet</a></li><li><a href="global.html#beginRound">beginRound</a></li><li><a href="global.html#bindAllElements">bindAllElements</a></li><li><a href="global.html#bindAllListeners">bindAllListeners</a></li><li><a href="global.html#bindElement">bindElement</a></li><li><a href="global.html#bindListeners">bindListeners</a></li><li><a href="global.html#bindPointData">bindPointData</a></li><li><a href="global.html#boards">boards</a></li><li><a href="global.html#buildArray">buildArray</a></li><li><a href="global.html#buildArrayBase">buildArrayBase</a></li><li><a href="global.html#buildArrayOfReferences">buildArrayOfReferences</a></li><li><a href="global.html#buildHTML">buildHTML</a></li><li><a href="global.html#buildPlayers">buildPlayers</a></li><li><a href="global.html#buildShip">buildShip</a></li><li><a href="global.html#checkEqualPoints">checkEqualPoints</a></li><li><a href="global.html#checkIfHitCell">checkIfHitCell</a></li><li><a href="global.html#checkIfShipCell">checkIfShipCell</a></li><li><a href="global.html#checkInBetween">checkInBetween</a></li><li><a href="global.html#checkValidPoint">checkValidPoint</a></li><li><a href="global.html#cloneExclusions">cloneExclusions</a></li><li><a href="global.html#cloneExMap">cloneExMap</a></li><li><a href="global.html#cloneObject">cloneObject</a></li><li><a href="global.html#cloneRules">cloneRules</a></li><li><a href="global.html#computerAttack">computerAttack</a></li><li><a href="global.html#configureHtml">configureHtml</a></li><li><a href="global.html#coordinate">coordinate</a></li><li><a href="global.html#cube">cube</a></li><li><a href="global.html#curry">curry</a></li><li><a href="global.html#defaultFleet">defaultFleet</a></li><li><a href="global.html#displayTargets">displayTargets</a></li><li><a href="global.html#documentDOMItem">documentDOMItem</a></li><li><a href="global.html#documentItem">documentItem</a></li><li><a href="global.html#elementChanges">elementChanges</a></li><li><a href="global.html#elementHasAttribute">elementHasAttribute</a></li><li><a href="global.html#endGame">endGame</a></li><li><a href="global.html#filterAdjacentPoints">filterAdjacentPoints</a></li><li><a href="global.html#filterObject">filterObject</a></li><li><a href="global.html#finalScore">finalScore</a></li><li><a href="global.html#findNextAttacker">findNextAttacker</a></li><li><a href="global.html#gameTile">gameTile</a></li><li><a href="global.html#generateElement">generateElement</a></li><li><a href="global.html#generateRandomFleet">generateRandomFleet</a></li><li><a href="global.html#generateStartEnd">generateStartEnd</a></li><li><a href="global.html#getAdjEdgeNonHitCells">getAdjEdgeNonHitCells</a></li><li><a href="global.html#getAdjNonHitCells">getAdjNonHitCells</a></li><li><a href="global.html#getAllNonHitCells">getAllNonHitCells</a></li><li><a href="global.html#getAllPoints">getAllPoints</a></li><li><a href="global.html#getALowStatusItem">getALowStatusItem</a></li><li><a href="global.html#getAxisLengths">getAxisLengths</a></li><li><a href="global.html#getAxisOfCoord">getAxisOfCoord</a></li><li><a href="global.html#getBrokenItems">getBrokenItems</a></li><li><a href="global.html#getBrokenShipsPlayers">getBrokenShipsPlayers</a></li><li><a href="global.html#getChildrenByClass">getChildrenByClass</a></li><li><a href="global.html#getChildrenByName">getChildrenByName</a></li><li><a href="global.html#getChildrenFromAttribute">getChildrenFromAttribute</a></li><li><a href="global.html#getDOMItemFromPoint">getDOMItemFromPoint</a></li><li><a href="global.html#getHighAbsoluteCoord">getHighAbsoluteCoord</a></li><li><a href="global.html#getHighAbsoluteCoordAxis">getHighAbsoluteCoordAxis</a></li><li><a href="global.html#getInBetween">getInBetween</a></li><li><a href="global.html#getLowStatusItems">getLowStatusItems</a></li><li><a href="global.html#getMax">getMax</a></li><li><a href="global.html#getMaxOrMin">getMaxOrMin</a></li><li><a href="global.html#getMin">getMin</a></li><li><a href="global.html#getNextAttacker">getNextAttacker</a></li><li><a href="global.html#getParentsByClass">getParentsByClass</a></li><li><a href="global.html#getParentsByName">getParentsByName</a></li><li><a href="global.html#getParentsFromAttribute">getParentsFromAttribute</a></li><li><a href="global.html#getPointsLine">getPointsLine</a></li><li><a href="global.html#getPointsLines">getPointsLines</a></li><li><a href="global.html#getTopParentItem">getTopParentItem</a></li><li><a href="global.html#hitTile">hitTile</a></li><li><a href="global.html#inArray">inArray</a></li><li><a href="global.html#initChildren">initChildren</a></li><li><a href="global.html#initRoot">initRoot</a></li><li><a href="global.html#lineEndPoint">lineEndPoint</a></li><li><a href="global.html#listenerOptions">listenerOptions</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#mainMenu">mainMenu</a></li><li><a href="global.html#mapObject">mapObject</a></li><li><a href="global.html#matrix">matrix</a></li><li><a href="global.html#mergeObjects">mergeObjects</a></li><li><a href="global.html#mergeObjectsBase">mergeObjectsBase</a></li><li><a href="global.html#mergeObjectsMutable">mergeObjectsMutable</a></li><li><a href="global.html#nextCell">nextCell</a></li><li><a href="global.html#notEmptyObjectOrArray">notEmptyObjectOrArray</a></li><li><a href="global.html#numDamangedParts">numDamangedParts</a></li><li><a href="global.html#playerSet">playerSet</a></li><li><a href="global.html#playerStats">playerStats</a></li><li><a href="global.html#point">point</a></li><li><a href="global.html#pointDifference">pointDifference</a></li><li><a href="global.html#pointDirection">pointDirection</a></li><li><a href="global.html#pointHasNegative">pointHasNegative</a></li><li><a href="global.html#queueTimeout">queueTimeout</a></li><li><a href="global.html#randDirection">randDirection</a></li><li><a href="global.html#randomInteger">randomInteger</a></li><li><a href="global.html#randomNumber">randomNumber</a></li><li><a href="global.html#randomStart">randomStart</a></li><li><a href="global.html#randomStartDir">randomStartDir</a></li><li><a href="global.html#recursiveMap">recursiveMap</a></li><li><a href="global.html#reduceObject">reduceObject</a></li><li><a href="global.html#registerListener">registerListener</a></li><li><a href="global.html#registerListeners">registerListeners</a></li><li><a href="global.html#removeChild">removeChild</a></li><li><a href="global.html#removeCircularReference">removeCircularReference</a></li><li><a href="global.html#renderHTML">renderHTML</a></li><li><a href="global.html#resetTargets">resetTargets</a></li><li><a href="global.html#retrieveListener">retrieveListener</a></li><li><a href="global.html#selectShipDirection">selectShipDirection</a></li><li><a href="global.html#selectTargetCoord">selectTargetCoord</a></li><li><a href="global.html#selectTargetPlayer">selectTargetPlayer</a></li><li><a href="global.html#setHiddenShip">setHiddenShip</a></li><li><a href="global.html#setHit">setHit</a></li><li><a href="global.html#setShip">setShip</a></li><li><a href="global.html#setViewShip">setViewShip</a></li><li><a href="global.html#ship">ship</a></li><li><a href="global.html#shipTile">shipTile</a></li><li><a href="global.html#square">square</a></li><li><a href="global.html#testPointsBetween">testPointsBetween</a></li><li><a href="global.html#tile">tile</a></li><li><a href="global.html#update3dCell">update3dCell</a></li><li><a href="global.html#updateElement">updateElement</a></li><li><a href="global.html#updateElements">updateElements</a></li><li><a href="global.html#updatePlayer">updatePlayer</a></li><li><a href="global.html#updatePlayerStats">updatePlayerStats</a></li><li><a href="global.html#updateScore">updateScore</a></li><li><a href="global.html#waterTile">waterTile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Oct 31 2017 08:12:26 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
